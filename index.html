<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Covid Chart</title>
        <link href="css/styles.css" rel="stylesheet" type="text/css" />
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="nav-top" id="mainnav">
            <div class="container">
                <a id="icon" href="#page-top">Covid Chart</a>
                <div class="navbar-buttons">
                    <ul class="navlist">
                        <li class="nav-item"><a href="#chart">Chart</a></li>
                        <li class="nav-item"><a href="#about">About</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <header>
            <div id="chart">
            </div>
        </header>
            <div id="about">
                <h1>A line plot on covid-19 cases, made with Plotly and data from the CDC</h1>
            </div>
        <script>
            // Get covid data from cdc
            const covidDataURL = "https://data.cdc.gov/resource/9mfq-cb36.json?$limit=100000"
            const covidChart = document.getElementById('chart');
            const navBar = document.getElementById('mainnav');

            // User is no longer at top of the page
            window.onscroll = function () { 
                if (document.documentElement.scrollTop <= 50 ) {
                    navBar.classList.remove("nav-scrolled");
                } 
                else {
                    navBar.classList.add("nav-scrolled");
                }
            };
            
            //search to see if the state exists in traces and if true return the object reference
            function findInArray(item, array){
                let exists = false
                for(let i=0; i < array.length; i++){
                    if (item == array[i].name){
                        return array[i];
                    }
                }
                return false;
            }
            
            // Sort the data based on date and then create the chart
            function loadChar(jsonData){
                let traces = [];
                // Sorting
                jsonData.sort(function(a, b) {
                    return ((a.submission_date < b.submission_date) ? -1 : ((a.name == b.name) ? 0 : 1));
                });
                // Create an object for all of the states/places found in the data
                for (let i = 0; i < jsonData.length; i++) {
                    if (!(findInArray(jsonData[i].state, traces))){
                        let trace= {
                            x: [],
                            y: [],
                            mode: 'lines',
                            name: jsonData[i].state
                        }
                        traces.push(trace);
                    }
                }

                // add the points
                for (let i = 0; i < jsonData.length; i++) {
                    trace = findInArray(jsonData[i].state, traces)
                    trace.x.push(jsonData[i].submission_date);
                    trace.y.push(jsonData[i].tot_cases);
                }
                // if more than one object, create the chart
                if (traces.length > 0){
                    Plotly.newPlot('chart', traces, {
                        width: 1200,
                        height: 800,
                        title: "Covid Cases in US States",
                        x: "Date",
                        y: "Number of Cases",
                        hovermode: 'closest',
                        color: "State"
                    });
                }
            };
            
            // get the covid cases data as a JSON file from cdc url
            function fetchData() {
                let xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        let returnData = JSON.parse(this.responseText);
                        loadChar(returnData);
                    }
                };
                xmlhttp.open("GET", covidDataURL, true);
                xmlhttp.send();
            };

            // run
            fetchData();
        </script>
    </body>
</html>
